

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Timing resolution and consumer logic &mdash; EBU-TT-Live Toolkit 2.1.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="genindex.html"/>
        <link rel="search" title="Search" href="search.html"/>
    <link rel="top" title="EBU-TT-Live Toolkit 2.1.1 documentation" href="index.html"/>
        <link rel="up" title="Overview of the EBU-TT live toolkit." href="overview.html"/>
        <link rel="next" title="Segmentation of EBU-TT-Live document sequences" href="segmentation.html"/>
        <link rel="prev" title="User input producer" href="user_input_producer.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> EBU-TT-Live Toolkit
          

          
          </a>

          
            
            
              <div class="version">
                2.1.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="overview.html">Overview of the EBU-TT live toolkit.</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="nodes_and_carriage_mechanisms.html">Nodes and Carriage Mechanisms</a></li>
<li class="toctree-l2"><a class="reference internal" href="scripts_and_their_functions.html">Scripts and their functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="configurator.html">Configuration files and <code class="docutils literal notranslate"><span class="pre">ebu-run</span></code></a></li>
<li class="toctree-l2"><a class="reference internal" href="validation.html">Document and sequence validation</a></li>
<li class="toctree-l2"><a class="reference internal" href="user_input_producer.html">User input producer</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Timing resolution and consumer logic</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#document-timings">Document Timings</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sequence-timings">Sequence Timings</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="segmentation.html">Segmentation of EBU-TT-Live document sequences</a></li>
<li class="toctree-l2"><a class="reference internal" href="deduplication.html">DeDuplication of EBU-TT-Live documents</a></li>
<li class="toctree-l2"><a class="reference internal" href="conversion.html">Conversion of EBU-TT-Live documents to EBU-TT-D documents</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="ebu_tt_live.html">Source code reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">EBU-TT-Live Toolkit</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
          <li><a href="overview.html">Overview of the EBU-TT live toolkit.</a> &raquo;</li>
        
      <li>Timing resolution and consumer logic</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/timing_resolution.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="timing-resolution-and-consumer-logic">
<h1>Timing resolution and consumer logic<a class="headerlink" href="#timing-resolution-and-consumer-logic" title="Permalink to this headline">¶</a></h1>
<p>EBU-TT part 3 deals with sequences of documents and creates a single timeline/sequence where
document begin and end events are kept. Resolving this takes resolving the document timings first.
After each document’s internal timing relationships have been worked out the document is inserted into the
timeline where possible collisions are detected and resolved with the possible discarding of documents in the process.</p>
<div class="section" id="document-timings">
<h2>Document Timings<a class="headerlink" href="#document-timings" title="Permalink to this headline">¶</a></h2>
<p>The document timing resolution logic is built using the validation framework and mostly is in
<code class="xref py py-class docutils literal notranslate"><span class="pre">ebu_tt_live.bindings.validation.TimingValidationMixin</span></code></p>
<p>The approach is that the element timing semantics require parent and children derived information to calculate
begin and end events on an absolute timeline. For this we hook into the Depth First Search that the validation framework
uses to process element validation. It is very important to note that the begin and end times can be
calculated either as the algorithm cascades down or on its way up in case information derived from children is required.</p>
<img src="_images/graphviz-2f94a68d995752b5619d94b03f7410b43726322e.png" alt="digraph shells {
    size=&quot;7,8&quot;;
    node [fontsize=24, shape = plaintext];
    &quot;Document level&quot; -&gt; L1 -&gt; L2 -&gt; L3 -&gt; L4;

    node [fontsize=20, shape = ellipse];
    { rank = same; &quot;Document level&quot; tt; }
    { rank = same; L1 body; }
    { rank = same; L2 div; }
    { rank = same; L3 p1 p2; }
    { rank = same; L4 span1 span2 span3; }

    /* 'visible' edges */
    tt -&gt; body;
    body -&gt; div;
    div -&gt; {p1 p2};
    p1 -&gt; {span1 span2};
    p2 -&gt; span3;

    /* ’invisible’ edges to adjust node placement */
    edge [style=invis];
    L4 -&gt; span1;
}" />
<p>The classes involved in the timing resolution are in the diagram below. For every type of element in the XSD there is
a python binding class defined. For the sake of simplicity the diagram only contains a fraction of them to provide
enough context but omits the parts that are irrelevant to the timing resolution logic.</p>
<div class="figure" id="id1">
<p class="plantuml">
<img src="_images/plantuml-eb36c67efa5abfdfe49a3f9eec26e14c9118a827.png" alt="&#64;startuml

class tt_type {
  #_semantic_before_validation()
  #_semantic_after_validation()
  #_semantic_before_traversal()
  #_semantic_after_traversal()
}
class body_type {
  #_semantic_before_traversal()
  #_semantic_after_traversal()
}
class div_type {
  #_semantic_before_traversal()
  #_semantic_after_traversal()
}
class p_type {
  #_semantic_before_traversal()
  #_semantic_after_traversal()
}
class span_type {
  #_semantic_before_traversal()
  #_semantic_after_traversal()
}

class SemanticValidationMixin {
  #_semantic_before_traversal()
  #_semantic_after_traversal()
}
class SemanticDocumentMixin {
  #_semantic_before_validation()
  #_semantic_after_validation()
  +validateBinding()
}
class TimingValidationMixin {
  #_semantic_preprocess_timing()
  #_semantic_postprocess_timing()
}
class RecursiveOperation {
  #{abstract}_process_element()
  #{abstract}_process_non_element()
  #_before_element()
  #_after_element()
  +proceed()
}
class SemanticValidator {
  #_process_element()
  #_process_non_element()
  #_before_element()
  #_after_element()
}

RecursiveOperation &lt;|-- SemanticValidator
SemanticValidationMixin --&gt; SemanticValidator
SemanticDocumentMixin &lt;|-- SemanticValidationMixin
SemanticDocumentMixin &lt;|-- tt_type
SemanticValidationMixin &lt;|-- body_type
SemanticValidationMixin &lt;|-- div_type
SemanticValidationMixin &lt;|-- p_type
SemanticValidationMixin &lt;|-- span_type
TimingValidationMixin &lt;|-- body_type
TimingValidationMixin &lt;|-- div_type
TimingValidationMixin &lt;|-- p_type
TimingValidationMixin &lt;|-- span_type

&#64;enduml
" />
</p>
<p class="caption"><span class="caption-text">Classes involved in timing resolution (Simplified)</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
<p>The functions <a class="reference internal" href="ebu_tt_live.bindings.validation.html#ebu_tt_live.bindings.validation.base.SemanticDocumentMixin._semantic_before_validation" title="ebu_tt_live.bindings.validation.base.SemanticDocumentMixin._semantic_before_validation"><code class="xref py py-func docutils literal notranslate"><span class="pre">ebu_tt_live.bindings.validation.base.SemanticDocumentMixin._semantic_before_validation()</span></code></a> and
<code class="xref py py-func docutils literal notranslate"><span class="pre">ebu_tt_live.bindings.validation.base.SemanticDocumentMixin._semantic_after_validation()</span></code> are hooks that run
before and after the Depth First Search traversal of the content tree.
The <a class="reference internal" href="ebu_tt_live.bindings.validation.html#ebu_tt_live.bindings.validation.base.SemanticValidationMixin._semantic_before_traversal" title="ebu_tt_live.bindings.validation.base.SemanticValidationMixin._semantic_before_traversal"><code class="xref py py-func docutils literal notranslate"><span class="pre">ebu_tt_live.bindings.validation.base.SemanticValidationMixin._semantic_before_traversal()</span></code></a> and
<a class="reference internal" href="ebu_tt_live.bindings.validation.html#ebu_tt_live.bindings.validation.base.SemanticValidationMixin._semantic_after_traversal" title="ebu_tt_live.bindings.validation.base.SemanticValidationMixin._semantic_after_traversal"><code class="xref py py-func docutils literal notranslate"><span class="pre">ebu_tt_live.bindings.validation.base.SemanticValidationMixin._semantic_after_traversal()</span></code></a> are element hooks,
which are called before the traversal logic gets to the element and after the traversal logic has finished processing
the children of the element in question. Types that subclass these mixins should override these functions to provide
their own customized hook behaviour. In the case of timing resolution another mixin,
<code class="xref py py-class docutils literal notranslate"><span class="pre">ebu_tt_live.bindings.validation.base.TimingValidationMixin</span></code> is involved, which encapsulates the functions
used to process <cite>begin</cite> and <cite>end</cite> attributes. In order for a particular element type to gain timing resolution
capability it needs to subclass <cite>TimingValidationMixin</cite> and <cite>SemanticValidationMixin</cite> and it must have <cite>begin</cite> and <cite>end</cite>
attributes capability. Then it should implement <cite>_semantic_before_traversal</cite> and <cite>_semantic_after_traversal</cite> functions
and call the <a class="reference internal" href="ebu_tt_live.bindings.validation.html#ebu_tt_live.bindings.validation.timing.TimingValidationMixin._semantic_preprocess_timing" title="ebu_tt_live.bindings.validation.timing.TimingValidationMixin._semantic_preprocess_timing"><code class="xref py py-class docutils literal notranslate"><span class="pre">ebu_tt_live.bindings.validation.timing.TimingValidationMixin._semantic_preprocess_timing</span></code></a>
in the before traversal and
<a class="reference internal" href="ebu_tt_live.bindings.validation.html#ebu_tt_live.bindings.validation.timing.TimingValidationMixin._semantic_postprocess_timing" title="ebu_tt_live.bindings.validation.timing.TimingValidationMixin._semantic_postprocess_timing"><code class="xref py py-class docutils literal notranslate"><span class="pre">ebu_tt_live.bindings.validation.timing.TimingValidationMixin._semantic_postprocess_timing</span></code></a> in the after
traversal hook. The following code sample is from the implementation of the div_type class.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">_semantic_before_traversal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">element_content</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">parent_binding</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_semantic_register_id</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_semantic_timebase_validation</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span> <span class="n">element_content</span><span class="o">=</span><span class="n">element_content</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_semantic_preprocess_timing</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span> <span class="n">element_content</span><span class="o">=</span><span class="n">element_content</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_semantic_set_region</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span> <span class="n">region_type</span><span class="o">=</span><span class="n">region_type</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_semantic_collect_applicable_styles</span><span class="p">(</span>
        <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span> <span class="n">style_type</span><span class="o">=</span><span class="n">style_type</span><span class="p">,</span> <span class="n">parent_binding</span><span class="o">=</span><span class="n">parent_binding</span><span class="p">,</span> <span class="n">defer_font_size</span><span class="o">=</span><span class="bp">True</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_semantic_push_styles</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_semantic_after_traversal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">element_content</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">parent_binding</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_semantic_postprocess_timing</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">,</span> <span class="n">element_content</span><span class="o">=</span><span class="n">element_content</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_semantic_unset_region</span><span class="p">(</span><span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">)</span>
</pre></div>
</div>
<p>In the following sequence diagram we traverse the document structure depicted in the first figure of this page and
process the timings.</p>
<div class="figure" id="id2">
<p class="plantuml">
<img src="_images/plantuml-41332e09a4f3bc33abde0b4e93c8ebd757b6edb9.png" alt="&#64;startuml

actor User
User --&gt; &quot;root : tt_type&quot; as root: validateBinding()
activate root

create &quot;validator : SemanticValidator&quot; as validator
root -&gt; validator : &lt;&lt;create&gt;&gt;
root -&gt; validator : process()
activate validator

validator -&gt; &quot;body : body_type&quot; as body: _semantic_before_traversal()
activate body

body -&gt; body : _semantic_preprocess_timing()
activate body
deactivate body

deactivate body

validator -&gt; &quot;div : div_type&quot; as div: _semantic_before_traversal()
activate div

div -&gt; div : _semantic_preprocess_timing()
activate div
deactivate div

deactivate div

validator -&gt; &quot;p1 : p_type&quot; as p1 : _semantic_before_traversal()
activate p1

p1 -&gt; p1 : _semantic_preprocess_timing()
activate p1
deactivate p1

deactivate p1

validator -&gt; &quot;span1 : span_type&quot; as span1 : _semantic_before_traversal()
activate span1

span1 -&gt; span1 : _semantic_preprocess_timing()
activate span1
deactivate span1

deactivate span1

validator -&gt; span1 : _semantic_after_traversal()
activate span1

span1 -&gt; span1: _semantic_postprocess_timing()
activate span1
deactivate span1

deactivate span1

validator -&gt; &quot;span2 : span_type&quot; as span2 : _semantic_before_traversal()
activate span2

span2 -&gt; span2 : _semantic_preprocess_timing()
activate span2
deactivate span2

deactivate span2

validator -&gt; span2 : _semantic_after_traversal()
activate span2

span2 -&gt; span2 : _semantic_postprocess_timing()
activate span2
deactivate span2

deactivate span2

validator -&gt; p1 : _semantic_after_traversal()
activate p1

p1 -&gt; p1 : _semantic_postprocess_timing()
activate p1
deactivate p1

deactivate p1

validator -&gt; &quot;p2 : p_type&quot; as p2 : _semantic_before_traversal()
activate p2

p2 -&gt; p2 : _semantic_preprocess_timing()
activate p2
deactivate p2

deactivate p2

validator -&gt; &quot;span3 : span_type&quot; as span3 : _semantic_before_traversal()
activate span3

span3 -&gt; span3 : _semantic_preprocess_timing()
activate span3
deactivate span3

deactivate span3

validator -&gt; span3 : _semantic_after_traversal()
activate span3

span3 -&gt; span3 : _semantic_postprocess_timing()
activate span3
deactivate span3

deactivate span3

validator -&gt; p2 : _semantic_after_traversal()
activate p2

p2 -&gt; p2 : _semantic_postprocess_timing()
activate p2
deactivate p2

deactivate p2

validator -&gt; div : _semantic_after_traversal()
activate div

div -&gt; div : _semantic_postprocess_timing()
activate div
deactivate div

deactivate div

validator -&gt; body : _semantic_after_traversal()
activate body

body -&gt; body : _semantic_postprocess_timing()
activate body
deactivate body

deactivate body

root &lt;- validator
destroy validator
User &lt;- root

deactivate root

&#64;enduml
" />
</p>
<p class="caption"><span class="caption-text">Timing validation of document tree (head element omitted as it is irrelevant to timing)</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</div>
</div>
<div class="section" id="sequence-timings">
<h2>Sequence Timings<a class="headerlink" href="#sequence-timings" title="Permalink to this headline">¶</a></h2>
<p>The sequence timings are handled by the <a class="reference internal" href="ebu_tt_live.documents.html#ebu_tt_live.documents.ebutt3.EBUTT3DocumentSequence" title="ebu_tt_live.documents.ebutt3.EBUTT3DocumentSequence"><code class="xref py py-class docutils literal notranslate"><span class="pre">ebu_tt_live.documents.ebutt3.EBUTT3DocumentSequence</span></code></a> class.
The document is inserted into the sequence after it is validated. The sequence looks at the computed begin and
end times and detects collisions. If there are any, the collisions are resolved by the logic starting in
<a class="reference internal" href="ebu_tt_live.documents.html#ebu_tt_live.documents.ebutt3.EBUTT3DocumentSequence._insert_or_discard" title="ebu_tt_live.documents.ebutt3.EBUTT3DocumentSequence._insert_or_discard"><code class="xref py py-func docutils literal notranslate"><span class="pre">ebu_tt_live.documents.ebutt3.EBUTT3DocumentSequence._insert_or_discard()</span></code></a></p>
</div>
</div>


           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="segmentation.html" class="btn btn-neutral float-right" title="Segmentation of EBU-TT-Live document sequences" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="user_input_producer.html" class="btn btn-neutral" title="User input producer" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, European Broadcasting Union.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'2.1.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>